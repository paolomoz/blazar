<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Blazar — Report Hub</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700;900&family=Source+Code+Pro:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --blue: #3B63FB;
  --blue-light: #EBF0FF;
  --blue-dark: #2A4AD4;
  --bg: #F8F8F8;
  --bg-white: #FFFFFF;
  --fg: #292929;
  --fg-heading: #131313;
  --fg-muted: #717171;
  --border: #E1E1E1;
  --red: #D7373F;
  --red-bg: #FFF0F0;
  --amber: #CB6F10;
  --amber-bg: #FFF5EB;
  --green: #12805C;
  --green-bg: #EDFCF2;
  --purple: #7A6AFD;
  --purple-bg: #F3F0FF;
  --cyan: #8AD5FF;
  --cyan-bg: #F0FAFF;
  --fuchsia: #DF4DF5;
  --shadow-card: 0 2px 8px rgba(0,0,0,0.08), 0 1px 4px rgba(0,0,0,0.04), 0 0 1px rgba(0,0,0,0.08);
  --shadow-elevated: 0 8px 24px rgba(0,0,0,0.12), 0 2px 8px rgba(0,0,0,0.08);
  --radius: 8px;
  --radius-sm: 4px;
  --radius-lg: 12px;
  --radius-pill: 9999px;
  --font: 'Source Sans Pro', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  --font-mono: 'Source Code Pro', Monaco, monospace;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { font-size: 16px; }
@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after { animation-duration: 0.01ms !important; transition-duration: 0.01ms !important; }
}
body { font-family: var(--font); color: var(--fg); background: var(--bg); line-height: 1.6; overflow: hidden; height: 100vh; }
a { color: var(--blue); text-decoration: none; }
a:hover { text-decoration: underline; }
:focus-visible { outline: 2px solid var(--blue); outline-offset: 2px; border-radius: 2px; }

/* ── App shell ── */
.app { display: flex; flex-direction: column; height: 100vh; }

/* ── Header ── */
.header {
  background: var(--bg-white);
  border-bottom: 1px solid var(--border);
  padding: 16px 24px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-shrink: 0;
  z-index: 100;
}
.header-left { display: flex; align-items: center; gap: 14px; }
.logo {
  width: 36px; height: 36px;
  border-radius: var(--radius);
  flex-shrink: 0;
}
.header h1 { font-size: 20px; font-weight: 900; color: var(--fg-heading); line-height: 1.2; }
.header-subtitle { font-size: 13px; color: var(--fg-muted); }
.view-toggle {
  display: flex;
  background: var(--bg);
  border-radius: var(--radius-pill);
  padding: 3px;
  gap: 2px;
}
.view-btn {
  padding: 6px 16px;
  border-radius: var(--radius-pill);
  border: none;
  background: transparent;
  font-family: var(--font);
  font-size: 13px;
  font-weight: 600;
  color: var(--fg-muted);
  cursor: pointer;
  transition: all 0.15s ease;
  display: flex;
  align-items: center;
  gap: 6px;
}
.view-btn:hover { color: var(--fg); }
.view-btn.active {
  background: var(--bg-white);
  color: var(--fg-heading);
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.view-btn svg { width: 14px; height: 14px; }

/* ── Mind map view ── */
.mindmap-view {
  flex: 1;
  position: relative;
  overflow: hidden;
  cursor: grab;
}
.mindmap-view:active { cursor: grabbing; }
.mindmap-canvas {
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  transform-origin: 0 0;
}

/* SVG edges */
.mindmap-svg {
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  pointer-events: none;
  z-index: 1;
}
.edge {
  fill: none;
  stroke: var(--border);
  stroke-width: 1.5;
  opacity: 0.5;
}
.edge-related {
  fill: none;
  stroke: var(--blue);
  stroke-width: 1;
  stroke-dasharray: 4 4;
  opacity: 0.15;
}

/* Nodes */
.node {
  position: absolute;
  z-index: 10;
  transform: translate(-50%, -50%);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.node:hover { z-index: 20; }

/* Central hub node — mini browser screenshot */
.node-hub {
  width: 150px; height: 120px;
  background: #1b1b2f;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 6px 28px rgba(0,0,0,0.35), 0 0 0 1px rgba(255,255,255,0.08);
  cursor: default;
  display: flex; flex-direction: column;
}
.node-hub .browser-chrome {
  height: 18px; min-height: 18px;
  background: #2a2a3d;
  display: flex; align-items: center;
  padding: 0 7px; gap: 4px;
}
.node-hub .browser-dot {
  width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0;
}
.node-hub .browser-dot:nth-child(1) { background: #ff5f57; }
.node-hub .browser-dot:nth-child(2) { background: #febc2e; }
.node-hub .browser-dot:nth-child(3) { background: #28c840; }
.node-hub .browser-url {
  flex: 1; background: rgba(255,255,255,0.08); border-radius: 3px;
  height: 10px; margin-left: 5px; font-size: 7px; color: rgba(255,255,255,0.5);
  display: flex; align-items: center; padding: 0 5px;
  font-family: system-ui, sans-serif; letter-spacing: 0.02em;
}
.node-hub .site-body { flex: 1; display: flex; flex-direction: column; }
.node-hub .site-nav {
  height: 10px; background: #16163a; display: flex; align-items: center;
  padding: 0 8px; gap: 6px;
}
.node-hub .site-nav span {
  width: 14px; height: 3px; border-radius: 1px; background: rgba(255,255,255,0.25);
}
.node-hub .site-nav span:first-child {
  width: 18px; height: 5px; border-radius: 2px; background: rgba(255,255,255,0.6);
}
.node-hub .site-hero {
  flex: 1; display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  background: linear-gradient(180deg, #1b1b2f 0%, #0d0d26 100%);
  padding: 4px 8px; gap: 3px;
}
.node-hub .site-hero .hero-tagline {
  font-size: 8px; font-weight: 800; color: #fff;
  letter-spacing: 0.03em; text-align: center; line-height: 1.2;
}
.node-hub .site-hero .hero-sub {
  font-size: 5px; color: rgba(255,255,255,0.4); text-align: center;
}
.node-hub .site-hero .hero-cta {
  margin-top: 2px; padding: 2px 8px; border-radius: 3px;
  background: var(--blue); font-size: 5px; color: #fff; font-weight: 700;
}
.node-hub .site-blocks {
  height: 22px; background: #f5f5f5; display: flex;
  align-items: center; justify-content: center; gap: 4px; padding: 0 6px;
}
.node-hub .site-blocks span {
  flex: 1; height: 12px; border-radius: 2px; background: #e0e0e0;
}

/* Category node */
.node-category {
  padding: 8px 18px;
  background: var(--bg-white);
  border: 2px solid var(--border);
  border-radius: var(--radius-pill);
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--fg-muted);
  cursor: default;
  white-space: nowrap;
}
.node-category[data-cat="audit"] { border-color: var(--amber); color: var(--amber); background: var(--amber-bg); }
.node-category[data-cat="optimization"] { border-color: var(--green); color: var(--green); background: var(--green-bg); }
.node-category[data-cat="brand"] { border-color: var(--purple); color: var(--purple); background: var(--purple-bg); }
.node-category[data-cat="content"] { border-color: var(--blue); color: var(--blue); background: var(--blue-light); }
.node-category[data-cat="performance"] { border-color: var(--red); color: var(--red); background: var(--red-bg); }
.node-category[data-cat="infra"] { border-color: var(--fg-muted); color: var(--fg-muted); }

/* Report node */
.node-report {
  width: 220px;
  background: var(--bg-white);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-card);
  border: 1px solid var(--border);
  overflow: hidden;
  cursor: pointer;
  text-decoration: none;
  color: inherit;
  display: block;
}
.node-report:hover {
  box-shadow: var(--shadow-elevated);
  text-decoration: none;
  border-color: var(--blue);
}
.node-report:hover .report-title { color: var(--blue); }
.report-accent {
  height: 4px;
  background: var(--border);
}
.report-accent[data-cat="audit"] { background: var(--amber); }
.report-accent[data-cat="optimization"] { background: var(--green); }
.report-accent[data-cat="brand"] { background: var(--purple); }
.report-accent[data-cat="content"] { background: var(--blue); }
.report-accent[data-cat="performance"] { background: var(--red); }
.report-accent[data-cat="infra"] { background: var(--fg-muted); }

.report-body { padding: 12px 14px; }
.report-title {
  font-size: 14px;
  font-weight: 700;
  color: var(--fg-heading);
  line-height: 1.3;
  margin-bottom: 6px;
  transition: color 0.15s;
}
.report-summary {
  font-size: 12px;
  color: var(--fg-muted);
  line-height: 1.4;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
.report-footer {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 14px;
  background: var(--bg);
  border-top: 1px solid var(--border);
  font-size: 12px;
  color: var(--fg-muted);
}
.report-badge {
  padding: 2px 10px;
  border-radius: var(--radius-pill);
  font-weight: 600;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.03em;
}
.report-badge[data-cat="audit"] { background: var(--amber-bg); color: var(--amber); }
.report-badge[data-cat="optimization"] { background: var(--green-bg); color: var(--green); }
.report-badge[data-cat="brand"] { background: var(--purple-bg); color: var(--purple); }
.report-badge[data-cat="content"] { background: var(--blue-light); color: var(--blue); }
.report-badge[data-cat="performance"] { background: var(--red-bg); color: var(--red); }
.report-badge[data-cat="infra"] { background: var(--bg); color: var(--fg-muted); }

/* Generating report card */
.node-report.generating {
  border: 2px solid var(--blue);
  animation: gen-card-pulse 2s ease-in-out infinite;
}
.node-report.generating .report-accent {
  background: linear-gradient(90deg, var(--blue) 0%, var(--cyan) 50%, var(--blue) 100%);
  background-size: 200% 100%;
  animation: gen-shimmer 1.5s linear infinite;
}
.node-report.generating .report-summary {
  color: var(--blue);
  font-style: italic;
}
@keyframes gen-card-pulse {
  0%, 100% { border-color: var(--blue); box-shadow: var(--shadow-card); }
  50% { border-color: #A8BFFF; box-shadow: 0 0 16px rgba(59,99,251,0.15), var(--shadow-card); }
}
@keyframes gen-shimmer {
  0% { background-position: -200% 0; }
  100% { background-position: 200% 0; }
}

/* ── Zoom controls ── */
.zoom-controls {
  position: absolute;
  bottom: 20px; right: 20px;
  display: flex; flex-direction: column;
  gap: 4px;
  z-index: 50;
}
.zoom-btn {
  width: 36px; height: 36px;
  border-radius: var(--radius);
  border: 1px solid var(--border);
  background: var(--bg-white);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  font-size: 18px; font-weight: 600; color: var(--fg-muted);
  font-family: var(--font);
  box-shadow: var(--shadow-card);
  transition: all 0.15s;
}
.zoom-btn:hover { color: var(--fg); border-color: var(--blue); }

/* Legend */
.legend {
  position: absolute;
  bottom: 20px; left: 20px;
  display: flex; gap: 12px;
  font-size: 12px; color: var(--fg-muted);
  z-index: 50;
  background: rgba(248,248,248,0.9);
  backdrop-filter: blur(8px);
  padding: 8px 14px;
  border-radius: var(--radius);
  border: 1px solid var(--border);
}
.legend-item { display: flex; align-items: center; gap: 5px; }
.legend-dot { width: 10px; height: 10px; border-radius: 50%; }

/* ── Timeline view ── */
.timeline-view {
  flex: 1;
  overflow-y: auto;
  padding: 40px 24px;
  display: none;
}
.timeline-container { max-width: 720px; margin: 0 auto; }
.timeline-heading {
  font-size: 28px; font-weight: 900; color: var(--fg-heading);
  margin-bottom: 8px;
}
.timeline-sub {
  font-size: 14px; color: var(--fg-muted); margin-bottom: 32px;
}

.timeline {
  position: relative;
  padding-left: 32px;
}
.timeline::before {
  content: '';
  position: absolute;
  left: 11px; top: 0; bottom: 0;
  width: 2px;
  background: var(--border);
}
.tl-entry { position: relative; margin-bottom: 28px; }
.tl-dot {
  position: absolute;
  left: -32px; top: 18px;
  width: 24px; height: 24px;
  border-radius: 50%;
  border: 3px solid var(--border);
  background: var(--bg-white);
  z-index: 2;
}
.tl-dot[data-cat="audit"] { border-color: var(--amber); }
.tl-dot[data-cat="optimization"] { border-color: var(--green); }
.tl-dot[data-cat="brand"] { border-color: var(--purple); }
.tl-dot[data-cat="content"] { border-color: var(--blue); }
.tl-dot[data-cat="performance"] { border-color: var(--red); }

.tl-card {
  display: block;
  background: var(--bg-white);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-card);
  border: 1px solid var(--border);
  overflow: hidden;
  text-decoration: none;
  color: inherit;
  transition: all 0.15s;
}
.tl-card:hover {
  box-shadow: var(--shadow-elevated);
  text-decoration: none;
  border-color: var(--blue);
}
.tl-card:hover .report-title { color: var(--blue); }
.tl-card-body { padding: 20px; }
.tl-date {
  font-size: 12px; font-weight: 600; color: var(--fg-muted);
  margin-bottom: 6px;
  text-transform: uppercase;
  letter-spacing: 0.03em;
}
.tl-card .report-title { font-size: 17px; margin-bottom: 8px; }
.tl-card .report-summary {
  -webkit-line-clamp: 4;
  font-size: 14px;
  margin-bottom: 12px;
}
.tl-tags { display: flex; gap: 6px; flex-wrap: wrap; }
.tl-related {
  font-size: 11px;
  padding: 3px 10px;
  border-radius: var(--radius-pill);
  background: var(--blue-light);
  color: var(--blue);
  font-weight: 600;
}

/* ── View switch ── */
.mindmap-view.hidden, .timeline-view.hidden { display: none; }
.mindmap-view:not(.hidden) { display: block; }
.timeline-view:not(.hidden) { display: block; }

/* ── Responsive ── */
@media (max-width: 640px) {
  .header { padding: 12px 16px; }
  .header h1 { font-size: 17px; }
  .header-subtitle { display: none; }
  .view-btn span { display: none; }
  .legend { display: none; }
  .node-report { width: 200px; }
}
</style>
</head>
<body>

<div class="app">
  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <img src="blazar-logo-36.svg" width="36" height="36" alt="" class="logo">
      <div>
        <h1>Blazar</h1>
        <div class="header-subtitle">Report Hub</div>
      </div>
    </div>
    <div class="view-toggle" role="tablist" aria-label="View mode">
      <button class="view-btn active" role="tab" aria-selected="true" data-view="mindmap" id="tab-mindmap" aria-controls="view-mindmap">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><line x1="12" y1="2" x2="12" y2="9"/><line x1="12" y1="15" x2="12" y2="22"/><line x1="2" y1="12" x2="9" y2="12"/><line x1="15" y1="12" x2="22" y2="12"/><line x1="4.93" y1="4.93" x2="9.17" y2="9.17"/><line x1="14.83" y1="14.83" x2="19.07" y2="19.07"/><line x1="4.93" y1="19.07" x2="9.17" y2="14.83"/><line x1="14.83" y1="9.17" x2="19.07" y2="4.93"/></svg>
        <span>Mind Map</span>
      </button>
      <button class="view-btn" role="tab" aria-selected="false" data-view="timeline" id="tab-timeline" aria-controls="view-timeline">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="20" x2="12" y2="4"/><polyline points="6 10 12 4 18 10"/></svg>
        <span>Timeline</span>
      </button>
    </div>
  </header>

  <!-- Mind Map View -->
  <div class="mindmap-view" id="view-mindmap" role="tabpanel" aria-labelledby="tab-mindmap">
    <div class="mindmap-canvas" id="mindmap-canvas">
      <svg class="mindmap-svg" id="mindmap-svg"></svg>
    </div>

    <div class="zoom-controls">
      <button class="zoom-btn" id="zoom-in" aria-label="Zoom in">+</button>
      <button class="zoom-btn" id="zoom-reset" aria-label="Reset zoom" style="font-size:12px;">1:1</button>
      <button class="zoom-btn" id="zoom-out" aria-label="Zoom out">&minus;</button>
    </div>

    <div class="legend">
      <div class="legend-item"><div class="legend-dot" style="background:var(--amber)"></div> Audit</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--green)"></div> Optimization</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--purple)"></div> Brand</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--blue)"></div> Content</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--red)"></div> Performance</div>
    </div>
  </div>

  <!-- Timeline View -->
  <div class="timeline-view hidden" id="view-timeline" role="tabpanel" aria-labelledby="tab-timeline">
    <div class="timeline-container">
      <h2 class="timeline-heading">Report Timeline</h2>
      <p class="timeline-sub">All reports in chronological order, newest first.</p>
      <div class="timeline" id="timeline-list"></div>
    </div>
  </div>
</div>

<script>
/* ────────────────────────────────────────────
   Manifest — loaded from /manifest.json (single source of truth)
   ──────────────────────────────────────────── */
let manifest = [];

/* ────────────────────────────────────────────
   Category metadata
   ──────────────────────────────────────────── */
const categories = {
  audit:        { label: "Audit",        color: "#CB6F10" },
  optimization: { label: "Optimization", color: "#12805C" },
  brand:        { label: "Brand",        color: "#7A6AFD" },
  content:      { label: "Content",      color: "#3B63FB" },
  performance:  { label: "Performance",  color: "#D7373F" },
  infra:        { label: "Infra",        color: "#717171" },
};

/* ────────────────────────────────────────────
   View switching
   ──────────────────────────────────────────── */
const viewBtns = document.querySelectorAll('.view-btn');
const mindmapView = document.getElementById('view-mindmap');
const timelineView = document.getElementById('view-timeline');

viewBtns.forEach(btn => {
  btn.addEventListener('click', () => {
    viewBtns.forEach(b => { b.classList.remove('active'); b.setAttribute('aria-selected', 'false'); });
    btn.classList.add('active');
    btn.setAttribute('aria-selected', 'true');
    const view = btn.dataset.view;
    mindmapView.classList.toggle('hidden', view !== 'mindmap');
    timelineView.classList.toggle('hidden', view !== 'timeline');
  });
});

/* ────────────────────────────────────────────
   Mind map — layout calculation
   ──────────────────────────────────────────── */
function buildMindmap() {
  const canvas = document.getElementById('mindmap-canvas');
  const svg = document.getElementById('mindmap-svg');
  const container = mindmapView;
  const W = container.clientWidth;
  const H = container.clientHeight;

  const usedCats = [...new Set(manifest.map(r => r.category))];
  const nodes = [];
  const edges = [];

  // Hub at origin
  nodes.push({ id: '__hub__', type: 'hub', x: 0, y: 0 });

  // Group reports by category
  const reportsByCategory = {};
  manifest.forEach(r => {
    if (!reportsByCategory[r.category]) reportsByCategory[r.category] = [];
    reportsByCategory[r.category].push(r);
  });

  // ── Proportional angle allocation ──
  // Each category gets angular space proportional to its report count + 1 (for gap)
  const totalSlots = manifest.length + usedCats.length; // reports + gaps between categories
  const catRadius = 200;
  const reportRadius = 480;

  let currentAngle = -Math.PI / 2; // start at top
  const catPositions = {};
  const reportPositions = {};

  usedCats.forEach(cat => {
    const reports = reportsByCategory[cat] || [];
    const slots = reports.length;
    const arcSize = (slots / totalSlots) * 2 * Math.PI;
    const gapSize = (1 / totalSlots) * 2 * Math.PI;

    // Category sits at the middle of its arc
    const catAngle = currentAngle + arcSize / 2;
    const cx = catRadius * Math.cos(catAngle);
    const cy = catRadius * Math.sin(catAngle);
    catPositions[cat] = { x: cx, y: cy, angle: catAngle };
    nodes.push({ id: `__cat_${cat}__`, type: 'category', x: cx, y: cy, cat });
    edges.push({ from: { x: 0, y: 0 }, to: { x: cx, y: cy }, type: 'hub-cat', cat });

    // Place reports evenly across this category's arc
    reports.forEach((r, i) => {
      const reportAngle = reports.length === 1
        ? catAngle
        : currentAngle + (i / (reports.length - 1)) * arcSize;
      const rx = reportRadius * Math.cos(reportAngle);
      const ry = reportRadius * Math.sin(reportAngle);
      reportPositions[r.id] = { x: rx, y: ry };
      nodes.push({ id: r.id, type: 'report', x: rx, y: ry, report: r, cat });
      edges.push({ from: { x: cx, y: cy }, to: { x: rx, y: ry }, type: 'branch', cat });
    });

    currentAngle += arcSize + gapSize;
  });

  // Related edges (cross-category only, to reduce clutter)
  manifest.forEach(r => {
    (r.related || []).forEach(relId => {
      const from = reportPositions[r.id];
      const to = reportPositions[relId];
      const target = manifest.find(m => m.id === relId);
      if (from && to && r.id < relId && target && target.category !== r.category) {
        edges.push({ from, to, type: 'related' });
      }
    });
  });

  // ── Auto-fit to viewport ──
  const CARD_W = 220, CARD_H = 150, HUB_R = 60, CAT_W = 80, CAT_H = 20;
  let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
  nodes.forEach(n => {
    let hw, hh;
    if (n.type === 'hub') { hw = HUB_R; hh = HUB_R; }
    else if (n.type === 'category') { hw = CAT_W; hh = CAT_H; }
    else { hw = CARD_W / 2; hh = CARD_H / 2; }
    minX = Math.min(minX, n.x - hw);
    maxX = Math.max(maxX, n.x + hw);
    minY = Math.min(minY, n.y - hh);
    maxY = Math.max(maxY, n.y + hh);
  });

  const contentW = maxX - minX;
  const contentH = maxY - minY;
  const pad = 50;
  const fitScale = Math.min((W - pad * 2) / contentW, (H - pad * 2) / contentH, 1.0);
  const contentCx = (minX + maxX) / 2;
  const contentCy = (minY + maxY) / 2;

  const toScreen = (ax, ay) => ({
    x: W / 2 + (ax - contentCx) * fitScale,
    y: H / 2 + (ay - contentCy) * fitScale,
  });

  nodes.forEach(n => { const s = toScreen(n.x, n.y); n.sx = s.x; n.sy = s.y; });
  edges.forEach(e => {
    const sf = toScreen(e.from.x, e.from.y);
    const st = toScreen(e.to.x, e.to.y);
    e.sfx = sf.x; e.sfy = sf.y; e.stx = st.x; e.sty = st.y;
  });

  // ── Render SVG edges ──
  svg.innerHTML = '';
  svg.setAttribute('width', W);
  svg.setAttribute('height', H);
  svg.style.width = W + 'px';
  svg.style.height = H + 'px';

  // Render related edges first (behind branches)
  edges.filter(e => e.type === 'related').forEach(e => {
    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    const mx = (e.sfx + e.stx) / 2;
    const dx = e.stx - e.sfx;
    const dy = e.sty - e.sfy;
    const len = Math.max(Math.hypot(dx, dy), 1);
    // Curve away from center
    const cx1 = mx - dy * 40 / len;
    const cy1 = (e.sfy + e.sty) / 2 + dx * 40 / len;
    path.setAttribute('d', `M${e.sfx},${e.sfy} Q${cx1},${cy1} ${e.stx},${e.sty}`);
    path.classList.add('edge-related');
    svg.appendChild(path);
  });

  // Hub → category lines (subtle straight)
  edges.filter(e => e.type === 'hub-cat').forEach(e => {
    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    path.setAttribute('d', `M${e.sfx},${e.sfy} L${e.stx},${e.sty}`);
    path.classList.add('edge');
    const catColor = categories[e.cat]?.color || '#E1E1E1';
    path.style.stroke = catColor;
    path.style.opacity = '0.3';
    path.style.strokeWidth = '2';
    svg.appendChild(path);
  });

  // Category → report lines (smooth curves)
  edges.filter(e => e.type === 'branch').forEach(e => {
    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    // Cubic bezier: pull control points along the radial direction
    const dx = e.stx - e.sfx;
    const dy = e.sty - e.sfy;
    const cx1 = e.sfx + dx * 0.6;
    const cy1 = e.sfy + dy * 0.1;
    const cx2 = e.sfx + dx * 0.4;
    const cy2 = e.sfy + dy * 0.9;
    path.setAttribute('d', `M${e.sfx},${e.sfy} C${cx1},${cy1} ${cx2},${cy2} ${e.stx},${e.sty}`);
    path.classList.add('edge');
    const catColor = categories[e.cat]?.color || '#E1E1E1';
    path.style.stroke = catColor;
    path.style.opacity = '0.25';
    svg.appendChild(path);
  });

  // ── Render HTML nodes ──
  canvas.querySelectorAll('.node').forEach(n => n.remove());

  nodes.forEach(n => {
    if (n.type === 'hub') {
      const el = document.createElement('div');
      el.className = 'node node-hub';
      el.style.left = n.sx + 'px';
      el.style.top = n.sy + 'px';
      el.innerHTML = `
        <div class="browser-chrome">
          <span class="browser-dot"></span><span class="browser-dot"></span><span class="browser-dot"></span>
          <span class="browser-url">aem.live</span>
        </div>
        <div class="site-body">
          <div class="site-nav">
            <span></span><span></span><span></span><span></span><span></span>
          </div>
          <div class="site-hero">
            <div class="hero-tagline">Build. Author.<br>Publish.</div>
            <div class="hero-sub">Your Edge Delivery Services site</div>
            <div class="hero-cta">Get started</div>
          </div>
          <div class="site-blocks"><span></span><span></span><span></span></div>
        </div>`;
      canvas.appendChild(el);
    } else if (n.type === 'category') {
      const el = document.createElement('div');
      el.className = 'node node-category';
      el.dataset.cat = n.cat;
      el.style.left = n.sx + 'px';
      el.style.top = n.sy + 'px';
      el.textContent = categories[n.cat]?.label || n.cat;
      canvas.appendChild(el);
    } else if (n.type === 'report') {
      const el = document.createElement('a');
      el.className = 'node node-report' + (n.report._generating ? ' generating' : '');
      el.href = n.report.file;
      if (n.report._generating) el.target = '_blank';
      el.style.left = n.sx + 'px';
      el.style.top = n.sy + 'px';
      const summaryText = n.report._generating ? 'Report is being written\u2026' : n.report.summary;
      el.innerHTML = `
        <div class="report-accent" data-cat="${n.report.category}"></div>
        <div class="report-body">
          <div class="report-title">${n.report.title}</div>
          <div class="report-summary">${summaryText}</div>
        </div>
        <div class="report-footer">
          <span class="report-badge" data-cat="${n.report.category}">${categories[n.report.category]?.label || n.report.category}</span>
          <span>${n.report._generating ? 'Generating\u2026' : n.report.date}</span>
        </div>`;
      canvas.appendChild(el);
    }
  });
}

/* ────────────────────────────────────────────
   Mind map — pan & zoom
   ──────────────────────────────────────────── */
let scale = 1;
let panX = 0, panY = 0;
let isPanning = false;
let startPanX, startPanY;

function applyTransform() {
  const canvas = document.getElementById('mindmap-canvas');
  canvas.style.transform = `translate(${panX}px, ${panY}px) scale(${scale})`;
}

mindmapView.addEventListener('mousedown', e => {
  if (e.target.closest('.node-report') || e.target.closest('.zoom-btn')) return;
  isPanning = true;
  startPanX = e.clientX - panX;
  startPanY = e.clientY - panY;
});
window.addEventListener('mousemove', e => {
  if (!isPanning) return;
  panX = e.clientX - startPanX;
  panY = e.clientY - startPanY;
  applyTransform();
});
window.addEventListener('mouseup', () => { isPanning = false; });

mindmapView.addEventListener('wheel', e => {
  e.preventDefault();
  const delta = e.deltaY > 0 ? -0.08 : 0.08;
  scale = Math.max(0.3, Math.min(3, scale + delta));
  applyTransform();
}, { passive: false });

document.getElementById('zoom-in').addEventListener('click', () => {
  scale = Math.min(3, scale + 0.15);
  applyTransform();
});
document.getElementById('zoom-out').addEventListener('click', () => {
  scale = Math.max(0.3, scale - 0.15);
  applyTransform();
});
document.getElementById('zoom-reset').addEventListener('click', () => {
  scale = 1; panX = 0; panY = 0;
  applyTransform();
});

/* ────────────────────────────────────────────
   Timeline — render
   ──────────────────────────────────────────── */
function buildTimeline() {
  const list = document.getElementById('timeline-list');
  const sorted = [...manifest].sort((a, b) => b.date.localeCompare(a.date));

  list.innerHTML = sorted.map(r => {
    const relatedNames = (r.related || [])
      .map(id => manifest.find(m => m.id === id))
      .filter(Boolean)
      .map(m => `<span class="tl-related">${m.title.split(':')[0].trim()}</span>`)
      .join('');

    return `
      <div class="tl-entry">
        <div class="tl-dot" data-cat="${r.category}"></div>
        <a class="tl-card" href="${r.file}">
          <div class="report-accent" data-cat="${r.category}"></div>
          <div class="tl-card-body">
            <div class="tl-date">${formatDate(r.date)}</div>
            <div class="report-title">${r.title}</div>
            <div class="report-summary">${r.summary}</div>
            <div class="tl-tags">
              <span class="report-badge" data-cat="${r.category}">${categories[r.category]?.label || r.category}</span>
              ${relatedNames}
            </div>
          </div>
        </a>
      </div>`;
  }).join('');
}

function formatDate(dateStr) {
  const d = new Date(dateStr + 'T00:00:00');
  return d.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
}

/* ────────────────────────────────────────────
   Live generation events from chat widget
   ──────────────────────────────────────────── */
window.addEventListener('blazar-report-generating', (e) => {
  const d = e.detail;
  if (!d || !d.id) return;
  // Remove existing entry with same id (if re-generating)
  const idx = manifest.findIndex(r => r.id === d.id);
  if (idx >= 0) manifest.splice(idx, 1);
  // Add temp generating entry
  manifest.push({
    id: d.id,
    file: '/r/' + d.id,
    title: d.title || 'Generating report\u2026',
    subtitle: d.subtitle || '',
    date: new Date().toISOString().split('T')[0],
    category: d.category || 'audit',
    summary: d.summary || '',
    related: d.related || [],
    _generating: true,
  });
  buildMindmap();
  buildTimeline();
  applyTransform();
});

window.addEventListener('blazar-report-generated', (e) => {
  const entry = e.detail?.manifest;
  if (!entry || !entry.id) return;
  // Replace the generating entry with the permanent one
  const idx = manifest.findIndex(r => r.id === entry.id);
  if (idx >= 0) {
    manifest[idx] = entry;
  } else {
    manifest.push(entry);
  }
  buildMindmap();
  buildTimeline();
  applyTransform();
});

/* ────────────────────────────────────────────
   Init — load manifest.json + KV generated reports
   ──────────────────────────────────────────── */
async function init() {
  // 1. Load static manifest (single source of truth)
  try {
    const resp = await fetch('manifest.json');
    if (resp.ok) {
      manifest = await resp.json();
    }
  } catch {}

  // 2. Merge generated reports from KV via API
  try {
    const resp = await fetch('/api/manifest');
    if (resp.ok) {
      const entries = await resp.json();
      if (Array.isArray(entries)) {
        const existingIds = new Set(manifest.map(r => r.id));
        entries.forEach(entry => {
          if (!existingIds.has(entry.id)) {
            manifest.push(entry);
          }
        });
      }
    }
  } catch {}

  // Normalize file paths to absolute
  manifest.forEach(r => {
    if (r.file && !r.file.startsWith('/')) {
      r.file = '/reports/' + r.file.replace(/\.html$/, '');
    }
  });

  buildMindmap();
  buildTimeline();
}
init();

window.addEventListener('resize', () => {
  buildMindmap();
  applyTransform();
});
window.addEventListener('blazar-chat-resize', () => {
  buildMindmap();
  applyTransform();
});
</script>
<script src="chat.js"></script>
</body>
</html>
